<!DOCTYPE HTML>
<html>

<head>
	<meta charset="utf-8">
	<title>BG真人娱乐</title>
	<meta name="viewport" id="viewport"
		content="width=device-width,initial-scale=1.0 ,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="full-screen" content="true" />
	<meta name="360-fullscreen" content="true" />
	<meta name="theme-color" content="#000">
	<!-- UC强制全屏 -->
	<meta name="full-screen" content="yes" />
	<meta name="browsermode" content="application" />
	<!-- QQ强制全屏 -->
	<meta name="x5-fullscreen" content="true" />
	<meta name="x5-page-mode" content="app" />
	<link rel="apple-touch-icon" sizes="144x144" href="pwa_dir/144x144.png">
	<link rel="manifest" id="my-manifest-placeholder">
	<link rel="stylesheet" href="pwa_dir/style-c60d5d6f64.css">
</head>

<body>
	<script>
		var version = "4.0.8.10";
		var pwa = location.search.indexOf("pwaMode=true") != -1 ||
			navigator.standalone ||
			window.matchMedia("(display-mode: standalone)").matches ||
			window.matchMedia("(display-mode: fullscreen)").matches
		console.warn("html_pwa  pwa", pwa, location.search);
		if (pwa && navigator.serviceWorker) {
			//pwa mode
			var loader = document.createElement("div");
			loader.id = "loader";
			document.body.appendChild(loader);
			cacheHandle();
		} else {
			//獲取locale參數
			var url = window.location.href;
			var wls = url.indexOf('?') != -1 ? "?" + url.split('?')[1] : "";
			var args = parse(wls);
			function parse(str) {
				var ret = {};
				if (!str) {
					return ret;
				}
				var seg = str.replace(/^\?/, "").split('&');
				for (var i = seg.length - 1; i >= 0; i--) {
					if (!seg[i]) {
						continue;
					}
					var s = seg[i].split('=');
					ret[s[0]] = s[1];
				}
				return ret;
			};
			if (args.locale && args.locale.indexOf("-") != -1) {
				var loc = args.locale.replace(/-/g, "_")
				args.locale = loc;

			}
			// 取得locale json資料
			var request = new XMLHttpRequest();
			request.open('GET', 'pwa_dir/locale-1bf1748ea4.json', true);
			request.onload = function () {
				if (request.status >= 200 && request.status < 400) {
					// Success!
					var data = JSON.parse(request.responseText);
					var content = document.createElement("div");
					content.id = "contentPWA";
					document.body.appendChild(content);
					var divWord = document.createElement("div");
					var divImage = document.createElement("div");
					divImage.id = "divImg";
					var infoImage = document.createElement("img");
					infoImage.id = "infoImage";
					divImage.appendChild(infoImage);
					var ua = navigator.userAgent || navigator.vendor || window.opera;
					divWord.id = "pwaWord";
					var locale = args.locale ? args.locale : "zh_CN";
					if(args.locale && args.locale=="ms_MY") locale = "id_ID"
					if (data[locale]) {
						divWord.innerHTML = data[locale]
						infoImage.src = "pwa_dir/pwa_ios_" + locale + ".png";
					} else {
						divWord.innerHTML = data["en_US"]
						infoImage.src = "pwa_dir/pwa_ios_en_US.png";
					}
					content.appendChild(divWord);
					content.appendChild(divImage);
					addManifest();
				}
			};
			request.send();

		}
		function cacheHandle() {
			var bReloading;
			var reload = function () {
				if (!bReloading) {
					console.warn('html_pwa reload bReloading', bReloading, performance.now());
					bUrlLogout = true;
					bReloading = true;
					const startReload = () => {
						console.warn('===================  window.location.reload =======================', performance.now());
						window.location.reload();
					}
					// setInterval(startReload, 5000);
					startReload();
				}
			}
			var swFile = "pwa_sw.js";
			let scope = self.location.pathname;
			let idx = scope.lastIndexOf("/")
			scope = scope.substring(0, idx + 1);
			console.warn('html_pwa serviceWorker start', scope, navigator.serviceWorker.controller, performance.now());
			if (navigator.serviceWorker.controller) {
				console.warn('html_pwa serviceWorker controller postMessage CHECK', performance.now());
				navigator.serviceWorker.controller.postMessage({ type: "CHECK", value: version });
			}
			navigator.serviceWorker.addEventListener('message', (e) => {
				const data = e.data;
				if (data && data.type == "reload")
					reload();
			});
			navigator.serviceWorker.register(swFile, { scope: scope, updateViaCache: "none" }).then(function (reg) {
				console.warn("html_pwa ServiceWorker registration success ", performance.now());
				if (!navigator.serviceWorker.controller) {
					console.warn("html_pwa serviceWorker no controller", performance.now());
					reload();
				}
				setInterval(() => {
					console.warn("serviceWorker reg.update", performance.now());
					reg.update();
					if (navigator.serviceWorker.controller)
						navigator.serviceWorker.controller.postMessage({ type: "UPDATE", value: version });
				}, 60000);
				reg.update();
				var curState;
				if (reg.installing) {
					console.warn('serviceWorker installing', performance.now());
					curState = reg.installing;
				} else if (reg.waiting) {
					console.warn('serviceWorker waiting', performance.now());
					curState = reg.waiting;
					// reload();
				} else if (reg.active) {
					console.warn('serviceWorker active', performance.now());
					curState = reg.active;
				}
				if (curState) {
					curState.addEventListener("statechange", (e) => {
						console.warn("serviceWorker statechange", e.target.state, performance.now());
						switch (e.target.state) {
							case "installed":
							case "redundant":
							case "activating":
								reload();
						}
					});
				}
			});
		}
		function addManifest() {
			var start_url = self.location.origin + self.location.pathname;
			let urlParams = "?pwaMode=true&" + self.location.search.replace("?", "");
			let scope = self.location.pathname;
			let idx = scope.lastIndexOf("/")
			scope = window.location.origin + scope.substring(0, idx);

			var myDynamicManifest = {
				"name": "BG真人娱乐",
				"short_name": "BG Video(pwa)",
				"start_url": start_url + urlParams,
				"background_color": "#000000",
				"display": "fullscreen",
				"theme_color": "#2a2929",
				"icons": [
					{
						"src": scope + "/pwa_dir/16x16.png",
						"sizes": "16x16",
						"type": "image/png"
					},
					{
						"src": scope + "/pwa_dir/64x64.png",
						"sizes": "64x64",
						"type": "image/png"
					},
					{
						"src": scope + "/pwa_dir/128x128.png",
						"sizes": "128x128",
						"type": "image/png"
					},
					{
						"src": scope + "/pwa_dir/144x144.png",
						"sizes": "144x144",
						"type": "image/png"
					},
					{
						"src": scope + "/pwa_dir/256x256.png",
						"sizes": "256x256",
						"type": "image/png"
					},
					{
						"src": scope + "/pwa_dir/512x512.png",
						"sizes": "512x512",
						"purpose": "maskable",
						"type": "image/png"
					}
				],
				"screenshots": [
					{
						"src": scope + "/pwa_dir/512x512.png",
						"type": "image/png",
						"sizes": "512x512",
						"form_factor": "narrow"
					},
					{
						"src": scope + "/pwa_dir/512x512.png",
						"type": "image/jpg",
						"sizes": "512x512",
						"form_factor": "wide"
					}
				]
			}
			const stringManifest = JSON.stringify(myDynamicManifest);
			const blob = new Blob([stringManifest], { type: 'application/json' });
			const manifestURL = URL.createObjectURL(blob);
			document.querySelector('#my-manifest-placeholder').setAttribute('href', manifestURL);
		}
	</script>
</body>

</html>